---
title: "Practical Assignment 2 - Web and Text Mining"
author: "João Pires, Vanessa Silva"
date: "30 de Abril de 2017"
output: html_document
---
<br /> 

This report follows the analysis of [IMDB](http://www.imdb.com) movies and their reviews, is the retrieval of relevant information on movies and the analysis of the reviews (and respective scores) assigned by users of the site to the movies.
For this we will use our knowledge regarding web and text mining.

*Web Mining* consists of extracting information from the content of the pages, their links, and users' browsing logs, using data mining tools. 
Thus, we can divide Web Mining into three variants: Web Content Mining; Web Structure Mining; And Web Usage Mining.

*Text Mining* consists of extracting useful information from a collection of documents.
Involves basic pre-processing/text mining operations, such as identification/extraction of representative features, and identification of complex patterns as, e.g. relationships between previously identified concepts.
Text Mining exploits techniques/methodologies from data mining, machine learning, information retrieval, and corpus-based computational linguistics. Where corpus is a collection of documents.


**The Goal**

To use web and text mining to extract and study important informations in the movies and their reviews, of IMDB website.


##Necessary Packages

```{r, eval=FALSE, message=FALSE, warning=FALSE, results='hide'}
#Install the necessary packages
install.packages("rvest")
install.packages("tm")
```


```{r, message=FALSE, warning=FALSE}
#Load the necessary packages
library(rvest)
library(tm)
```


##Tasks

Using the information available in the IMDB site we will accomplish a series of tasks below.


###Find basic information

First we will find basic information as web page, diretor, cast, etc. of a movie based on a query string of the title.

```{r}
#Store web url
url_IMBD <- "http://www.imdb.com/"

# Submit the form on imdb.com for a movie description
Searchform <- function(session, query, type) {
  form <- html_form(session)[[1]]
  form <- set_values(form, q = query, s = type)
 
  return(submit_form(session, form))
}

# Returns web pages link
webPages <- function(listResults) {
  
  results <- listResults[[2]]
  
  #get web page link
  movieLink <- (results %>% html_nodes(".result_text > a") %>% html_attr("href"))
  movieLink <- paste(url_IMBD, movieLink, sep='')
  
  return(movieLink)
  
}

# Returns a list of the all movies that match to the search string in the site
listMoviesAll <- function(query, type) {
  #Simulate a session in an html browser
  sessionMovies <- html_session(url_IMBD)
  
  results <- Searchform(sessionMovies, query, type)
  
  return(list(results %>% html_nodes(".result_text") %>% html_text(), results))
}

# Returns a list of the movies that match to the search string, by decreasing order of confidence
listMovies <- function(query, maxNum, type) {
  
  r <- listMoviesAll(query, type)
  
  TMlist <- r[[1]]
  
  movieLink <- webPages(r)
  
  #get rankings
  movieRanking <- lapply(movieLink, . %>% read_html() %>% html_nodes("strong span") %>% html_text())
  movieRanking <- as.array(movieRanking)
  
  #get date frame with movies and their ranking
  ResulList <- data.frame(as.array(TMlist),movieRanking)
  names(ResulList) <- c("Movies", "Ranking")
  ResulList$Ranking <- as.double(ResulList$Ranking)
  
  return(as.list((head(ResulList[order(ResulList$Ranking, decreasing=TRUE), ], maxNum))$Movies))
}

Type <- "tt"
Query <- "Lego"       #search string
#add an extra parameter that controls the maximum number of retrieved movies
NumMovies <- 10       #top 10

ResultListMovies <- listMovies(Query, NumMovies, Type)    #Demora um bom bocado a executar

##For each movie the basic information is returned as a list: 

# Get link from web pages of n movies

FullList <- listMoviesAll(Query, Type)
results <- FullList[2][[1]]
movieLink <- webPages(list(results %>% html_nodes(".result_text") %>% html_text(), results))

links <- matrix(nrow=10,ncol=2)
idx <- 1

for(i in 1:length(movieLink))
  for(j in 1:length(ResultListMovies))
    if (ResultListMovies[j][[1]] == FullList[1][[1]][i]){
      links[idx, 1] <- movieLink[i]
      links[idx,2] <- j
      idx <- idx+1
    }

movieLink <- matrix(ncol = 10)

for(i in 1:10) {
  idx <- as.integer(links[i,2])
  movieLink[idx] <- links[i,1]
}
movieLink <- as.character(movieLink)

# Find basic information

##web page
(WebPage <- lapply(movieLink, . %>% read_html()))

##director(s)
(Director_s <- lapply(movieLink, . %>% read_html() %>% html_nodes(".summary_text+ .credit_summary_item .itemprop") %>% html_text()))

##cast
(Cast <- lapply(movieLink, . %>% read_html() %>% html_nodes("#titleCast .itemprop span") %>% html_text())) ##See full cast Â»????

##description
(Description <- lapply(movieLink, . %>% read_html() %>% html_nodes(".summary_text") %>% html_text()))

##storyline
(Storyline <- lapply(movieLink, . %>% read_html() %>% html_nodes("#titleStoryLine p") %>% html_text()))

##original title
(OriginalTitle <- lapply(movieLink, . %>% read_html() %>% html_nodes(".originalTitle") %>% html_text()))

##runtime
(Runtime <-lapply(movieLink, . %>% read_html() %>% html_nodes("#titleDetails time") %>% html_text()))

##genre
(Genre <- lapply(movieLink, . %>% read_html() %>% html_nodes(".subtext .itemprop") %>% html_text()))

##date
(Date <- lapply(movieLink, . %>% read_html() %>% html_nodes(".subtext a~ .ghost+ a") %>% html_text()))

##rating
(Rating <- lapply(movieLink, . %>% read_html() %>% html_nodes("strong span") %>% html_text()))

##metascore
(Metascore <- lapply(movieLink, . %>% read_html() %>% html_nodes(".score_favorable span") %>% html_text()))

##... (more informations?)
```


###Obtain the information on all reviews from a movie

```{r}
# Lego movie:
lego_movie_link <- "http://www.imdb.com/title/tt1490017/"
lego_movie <- read_html(lego_movie_link)

# Number of comments:
n_comments <- as.integer(strsplit((lego_movie %>% html_nodes(".user-comments a"))[4] %>% html_text(), " ")[[1]][3])

# Page with all comments (eg.: http://www.imdb.com/title/tt1490017/reviews?count=480&start=0):
comment_page <- paste(lego_movie_link, "reviews?count=", n_comments, "&start=0", sep = "")

# All reviews
comments <- comment_page %>% read_html() %>% html_nodes("#pagecontent") %>% html_nodes("div+ p") %>% html_text()

# Stars given (to be solved):
tmp <- comment_page %>% read_html() %>% html_nodes("#tn15content") %>% html_nodes("div img")
stars <- tmp[seq(2, length(tmp), by = 2)]
#html_attr("alt")
```


###Model to predict the grade

####Build a data set for learning

####Try a few prediction models and draw conclusions

###Summarise the reviews of a movie